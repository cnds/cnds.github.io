<!DOCTYPE html>
<html lang=en>
<head><meta name="generator" content="Hexo 3.9.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="Mock是Python unittest中的一个模块，用来模拟函数的返回值，但在mock某个函数时，需要注意，不同的函数有不同的表现  现象普通函数和静态函数 首先来看普通的函数 123456789101112131415161718from unittest.mock import Mockdef single_func(data):    return &apos;single func: %s&apos; %">
<meta name="keywords" content="python,mock">
<meta property="og:type" content="article">
<meta property="og:title" content="Python Mock 的细节">
<meta property="og:url" content="http://cnds.github.io/2019/03/01/Python Mock的细节/index.html">
<meta property="og:site_name" content="Ding Song">
<meta property="og:description" content="Mock是Python unittest中的一个模块，用来模拟函数的返回值，但在mock某个函数时，需要注意，不同的函数有不同的表现  现象普通函数和静态函数 首先来看普通的函数 123456789101112131415161718from unittest.mock import Mockdef single_func(data):    return &apos;single func: %s&apos; %">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2020-01-02T14:33:18.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Python Mock 的细节">
<meta name="twitter:description" content="Mock是Python unittest中的一个模块，用来模拟函数的返回值，但在mock某个函数时，需要注意，不同的函数有不同的表现  现象普通函数和静态函数 首先来看普通的函数 123456789101112131415161718from unittest.mock import Mockdef single_func(data):    return &apos;single func: %s&apos; %">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Python Mock 的细节</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- rss -->
    
    
</head>

<body>
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/gabithume">Projects</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" href="/2018/12/20/面试记录/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://cnds.github.io/2019/03/01/Python Mock的细节/"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://cnds.github.io/2019/03/01/Python Mock的细节/&text=Python Mock 的细节"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://cnds.github.io/2019/03/01/Python Mock的细节/&title=Python Mock 的细节"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://cnds.github.io/2019/03/01/Python Mock的细节/&is_video=false&description=Python Mock 的细节"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Python Mock 的细节&body=Check out this article: http://cnds.github.io/2019/03/01/Python Mock的细节/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://cnds.github.io/2019/03/01/Python Mock的细节/&title=Python Mock 的细节"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://cnds.github.io/2019/03/01/Python Mock的细节/&title=Python Mock 的细节"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://cnds.github.io/2019/03/01/Python Mock的细节/&title=Python Mock 的细节"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://cnds.github.io/2019/03/01/Python Mock的细节/&title=Python Mock 的细节"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://cnds.github.io/2019/03/01/Python Mock的细节/&name=Python Mock 的细节&description="><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#现象"><span class="toc-number">1.</span> <span class="toc-text">现象</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#普通函数和静态函数"><span class="toc-number">1.0.1.</span> <span class="toc-text">普通函数和静态函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#单例模式下的函数"><span class="toc-number">1.0.2.</span> <span class="toc-text">单例模式下的函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#普通类的函数"><span class="toc-number">1.0.3.</span> <span class="toc-text">普通类的函数</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#原理"><span class="toc-number">2.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">3.</span> <span class="toc-text">总结</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Python Mock 的细节
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Ding Song</span>
      </span>
      
    <div class="postdate">
        <time datetime="2019-03-01T09:16:28.000Z" itemprop="datePublished">2019-03-01</time>
    </div>


      
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/mock/">mock</a>, <a class="tag-link" href="/tags/python/">python</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <ul>
<li>Mock是Python unittest中的一个模块，用来模拟函数的返回值，但在mock某个函数时，需要注意，不同的函数有不同的表现</li>
</ul>
<h2 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h2><h4 id="普通函数和静态函数"><a href="#普通函数和静态函数" class="headerlink" title="普通函数和静态函数"></a>普通函数和静态函数</h4><ul>
<li><p>首先来看普通的函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> unittest.mock <span class="keyword">import</span> Mock</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">single_func</span><span class="params">(data)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'single func: %s'</span> % data</span><br><span class="line">        </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line"></span><br><span class="line">    print(<span class="string">'&lt;&lt;&lt;==========================FUNCTION======================&gt;&gt;&gt;'</span>)</span><br><span class="line">    rs1 = single_func(<span class="string">'no mock 1'</span>)</span><br><span class="line">    rs2 = single_func(<span class="string">'no mock 2'</span>)</span><br><span class="line">    print(<span class="string">'origin func 1: %s, id: %s'</span> % (rs1, id(rs1)))</span><br><span class="line">    print(<span class="string">'origin func 2: %s, id: %s'</span> % (rs2, id(rs2)))</span><br><span class="line">    print(<span class="string">'origin func property: %s'</span> % single_func.__dict__)</span><br><span class="line">    single_func = Mock(return_value=<span class="string">'mocked'</span>)</span><br><span class="line">    print(<span class="string">'mocked func property: %s'</span> % single_func.__dict__)</span><br><span class="line">    print(<span class="string">'mocked func1: %s, id: %s'</span> % (single_func(<span class="string">'no mock 1'</span>), id(single_func(<span class="string">'no mock 1'</span>))))</span><br><span class="line">    print(<span class="string">'mocked func2: %s, id: %s'</span> % (single_func(<span class="string">'no mock 2'</span>), id(single_func(<span class="string">'no mock 2'</span>))))</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>以上代码mock了<code>single_func</code>这个函数，运行结果如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;&lt;&lt;==========================FUNCTION======================&gt;&gt;&gt;</span><br><span class="line">origin func 1: single func: no mock 1, id: 2590139904048</span><br><span class="line">origin func 2: single func: no mock 2, id: 2590139904120</span><br><span class="line">origin func property: &#123;&#125;</span><br><span class="line">mocked func property: &#123;'_mock_return_value': 'mocked', '_mock_parent': None, '_mock_name': None, '_mock_new_name': '', '_mock_new_parent': None, '_mock_sealed': False, '_spec_class': None, '_spec_set': None, '_spec_signature': None, '_mock_methods': None, '_mock_children': &#123;&#125;, '_mock_wraps': None, '_mock_delegate': None, '_mock_called': False, '_mock_call_args': None, '_mock_call_count': 0, '_mock_call_args_list': [], '_mock_mock_calls': [], 'method_calls': [], '_mock_unsafe': False, '_mock_side_effect': None&#125;</span><br><span class="line">mocked func1: mocked, id: 2590132817456</span><br><span class="line">mocked func2: mocked, id: 2590132817456</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>这里面有几个细节：</p>
<ul>
<li>首先在没有mock之前，函数的两次调用结果和内存地址是不同的</li>
<li>mock之后，两次调用的结果就相同了，而且函数的属性也发生了变化<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">  * 两次运行不仅结果相同，而且内存地址也相同</span><br><span class="line"></span><br><span class="line">* 同样地，静态方法的运行结果如下，和普通函数没有什么区别：</span><br><span class="line"></span><br><span class="line">  ```python</span><br><span class="line">  from unittest.mock import Mock</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  class StaticClass(object):</span><br><span class="line">  </span><br><span class="line">      @staticmethod</span><br><span class="line">      def static_func(data):</span><br><span class="line">          return &apos;static func: %s&apos; % data</span><br><span class="line">  </span><br><span class="line">          </span><br><span class="line">  if __name__ == &apos;__main__&apos;:</span><br><span class="line">  </span><br><span class="line">      print(&apos;&lt;&lt;&lt;==========================STATICMETHOD======================&gt;&gt;&gt;&apos;)</span><br><span class="line">      rs1 = StaticClass.static_func(&apos;no mock 1&apos;)</span><br><span class="line">      rs2 = StaticClass.static_func(&apos;no mock 2&apos;)</span><br><span class="line">      print(&apos;origin func 1: %s, id: %s&apos; % (rs1, id(rs1)))</span><br><span class="line">      print(&apos;origin func 2: %s, id: %s&apos; % (rs2, id(rs2)))</span><br><span class="line">      print(&apos;origin func property: %s&apos; % StaticClass.static_func.__dict__)</span><br><span class="line">      StaticClass.static_func = Mock(return_value=&apos;mocked&apos;)</span><br><span class="line">      print(&apos;mocked func property: %s&apos; % StaticClass.static_func.__dict__)</span><br><span class="line">      rs3 = StaticClass.static_func(&apos;no mock 3&apos;)</span><br><span class="line">      rs4 = StaticClass.static_func(&apos;no mock 4&apos;)</span><br><span class="line">      print(&apos;mocked func1: %s, id: %s&apos; % (rs3, id(rs4)))</span><br><span class="line">      print(&apos;mocked func2: %s, id: %s&apos; % (rs4, id(rs4)))</span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">origin func 1: static func: no mock 1, id: 2472839443488</span><br><span class="line">origin func 2: static func: no mock 2, id: 2472839430056</span><br><span class="line">origin func property: &#123;&#125;</span><br><span class="line">mocked func property: &#123;'_mock_return_value': 'mocked', '_mock_parent': None, '_mock_name': None, '_mock_new_name': '', '_mock_new_parent': None, '_mock_sealed': False, '_spec_class': None, '_spec_set': None, '_spec_signature': None, '_mock_methods': None, '_mock_children': &#123;&#125;, '_mock_wraps': None, '_mock_delegate': None, '_mock_called': False, '_mock_call_args': None, '_mock_call_count': 0, '_mock_call_args_list': [], '_mock_mock_calls': [], 'method_calls': [], '_mock_unsafe': False, '_mock_side_effect': None&#125;</span><br><span class="line">mocked func1: mocked, id: 2472832355888</span><br><span class="line">mocked func2: mocked, id: 2472832355888</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="单例模式下的函数"><a href="#单例模式下的函数" class="headerlink" title="单例模式下的函数"></a>单例模式下的函数</h4><ul>
<li><p>先看代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> unittest.mock <span class="keyword">import</span> Mock</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SingletonClass</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(cls, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> hasattr(cls, <span class="string">'_instance'</span>):</span><br><span class="line">            origin = super(SingletonClass, cls)</span><br><span class="line">            cls._instance = origin.__new__(cls, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> cls._instance</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">singleton_func</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'singleton func: %s'</span> % data</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line"></span><br><span class="line">    print(<span class="string">'&lt;&lt;&lt;==========================SINGLETON FUNCTION======================&gt;&gt;&gt;'</span>)</span><br><span class="line">    singleton_cls = SingletonClass()</span><br><span class="line">    rs1 = singleton_cls.singleton_func(<span class="string">'no mock 1'</span>)</span><br><span class="line">    rs2 = singleton_cls.singleton_func(<span class="string">'no mock 2'</span>)</span><br><span class="line">    print(<span class="string">'origin func 1: %s, id: %s'</span> % (rs1, id(rs1)))</span><br><span class="line">    print(<span class="string">'origin func 2: %s, id: %s'</span> % (rs2, id(rs2)))</span><br><span class="line">    print(<span class="string">'origin func property: %s'</span> % StaticClass.static_func.__dict__)</span><br><span class="line">    singleton_cls.singleton_func = Mock(return_value=<span class="string">'mocked'</span>)</span><br><span class="line">    print(<span class="string">'mocked func property: %s'</span> % singleton_cls.singleton_func.__dict__)</span><br><span class="line">    rs3 = SingletonClass().singleton_func(<span class="string">'no mock 3'</span>)</span><br><span class="line">    rs4 = SingletonClass().singleton_func(<span class="string">'no mock 4'</span>)</span><br><span class="line">    print(<span class="string">'mocked func1: %s, id: %s'</span> % (rs3, id(rs3)))</span><br><span class="line">    print(<span class="string">'mocked func2: %s, id: %s'</span> % (rs4, id(rs4)))</span><br></pre></td></tr></table></figure>
</li>
<li><p>结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">origin func 1: singleton func: no mock 1, id: 2472839479744</span><br><span class="line">origin func 2: singleton func: no mock 2, id: 2472839479824</span><br><span class="line">origin func property: &#123;'_mock_return_value': 'mocked', '_mock_parent': None, '_mock_name': None, '_mock_new_name': '', '_mock_new_parent': None, '_mock_sealed': False, '_spec_class': None, '_spec_set': None, '_spec_signature': None, '_mock_methods': None, '_mock_children': &#123;&#125;, '_mock_wraps': None, '_mock_delegate': None, '_mock_called': True, '_mock_call_args': call('no mock 4'), '_mock_call_count': 2, '_mock_call_args_list': [call('no mock 3'), call('no mock 4')], '_mock_mock_calls': [call('no mock 3'), call('no mock 4')], 'method_calls': [], '_mock_unsafe': False, '_mock_side_effect':</span><br><span class="line">None&#125;</span><br><span class="line">mocked func property: &#123;'_mock_return_value': 'mocked', '_mock_parent': None, '_mock_name': None, '_mock_new_name': '', '_mock_new_parent': None, '_mock_sealed': False, '_spec_class': None, '_spec_set': None, '_spec_signature': None, '_mock_methods': None, '_mock_children': &#123;&#125;, '_mock_wraps': None, '_mock_delegate': None, '_mock_called': False, '_mock_call_args': None, '_mock_call_count': 0, '_mock_call_args_list': [], '_mock_mock_calls': [], 'method_calls': [], '_mock_unsafe': False, '_mock_side_effect': None&#125;</span><br><span class="line">mocked func1: mocked, id: 2472832355888</span><br><span class="line">mocked func2: mocked, id: 2472832355888</span><br></pre></td></tr></table></figure>
</li>
<li><p>与普通函数和静态函数相比，尽管mock之后的函数调用采用了重新创建实例的方式，由于单例模式的特点，结果并没有区别，还是被成功的mock</p>
</li>
</ul>
<h4 id="普通类的函数"><a href="#普通类的函数" class="headerlink" title="普通类的函数"></a>普通类的函数</h4><ul>
<li><p>代码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">from unittest.mock import Mock</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class NormalClass(object):</span><br><span class="line">    </span><br><span class="line">    def normal_func(self, data):</span><br><span class="line">        return 'normal func %s' % data</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">if __name__ == '__main__':</span><br><span class="line"></span><br><span class="line">    print('&lt;&lt;&lt;==========================NORMAL FUNCTION======================&gt;&gt;&gt;')</span><br><span class="line">    normal_cls = NormalClass()</span><br><span class="line">    rs1 = normal_cls.normal_func('no mock 1')</span><br><span class="line">    rs2 = normal_cls.normal_func('no mock 2')</span><br><span class="line">    print('origin func 1: %s, id: %s' % (rs1, id(rs1)))</span><br><span class="line">    print('origin func 2: %s, id: %s' % (rs2, id(rs2)))</span><br><span class="line">    print('origin func property: %s' % normal_cls.normal_func.__dict__)</span><br><span class="line">    normal_cls.normal_func = Mock(return_value='mocked')</span><br><span class="line">    print('mocked func property: %s' % normal_cls.normal_func.__dict__)</span><br><span class="line">    rs3 = NormalClass().normal_func('no mock 3')</span><br><span class="line">    rs4 = NormalClass().normal_func('no mock 4')</span><br><span class="line">    print('mocked func1: %s, id: %s' % (rs3, id(rs3)))</span><br><span class="line">    print('mocked func2: %s, id: %s' % (rs4, id(rs4)))</span><br></pre></td></tr></table></figure>
</li>
<li><p>结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">origin func 1: normal func no mock 1, id: 2308646795496</span><br><span class="line">origin func 2: normal func no mock 2, id: 2308646795568</span><br><span class="line">origin func property: &#123;&#125;</span><br><span class="line">mocked func property: &#123;'_mock_return_value': 'mocked', '_mock_parent': None, '_mock_name': None, '_mock_new_name': '', '_mock_new_parent': None, '_mock_sealed': False, '_spec_class': None, '_spec_set': None, '_spec_signature': None, '_mock_methods': None, '_mock_children': &#123;&#125;, '_mock_wraps': None, '_mock_delegate': None, '_mock_called': False, '_mock_call_args': None, '_mock_call_count': 0, '_mock_call_args_list': [], '_mock_mock_calls': [], 'method_calls': [], '_mock_unsafe': False, '_mock_side_effect': None&#125;</span><br><span class="line">mocked func1: normal func no mock 3, id: 2308646796000</span><br><span class="line">mocked func2: normal func no mock 4, id: 2308646796216</span><br><span class="line">mocked func3: mocked, id: 2308639706672</span><br></pre></td></tr></table></figure>
</li>
<li><p>与单例模式的方式一样，采用了重新创建实例的方式，这次的结果并没有被mock</p>
</li>
</ul>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><ul>
<li><p>Mock实际上是利用了<a href="https://en.wikipedia.org/wiki/Monkey_patch" target="_blank" rel="noopener">Monkey Patch</a>的特性，在运行时替换了函数</p>
</li>
<li><p>自己的简单Mock，仅实现了return_value</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MySimpleMock</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, return_value)</span>:</span></span><br><span class="line">        self.return_value = return_value</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, return_value)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.return_value</span><br><span class="line">   </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SingletonClass</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(cls, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> hasattr(cls, <span class="string">'_instance'</span>):</span><br><span class="line">            origin = super(SingletonClass, cls)</span><br><span class="line">            cls._instance = origin.__new__(cls, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> cls._instance</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">singleton_func</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'singleton func: %s'</span> % data</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    singleton_cls = SingletonClass()</span><br><span class="line">    singleton_cls.singleton_func = MySimpleMock(return_value=<span class="string">'my simple mock'</span>)</span><br><span class="line">    rs7 = singleton_cls.singleton_func(<span class="string">'test simple mock'</span>)</span><br><span class="line">    rs8 = singleton_cls.singleton_func(<span class="string">'test simple mock'</span>)</span><br><span class="line">    print(<span class="string">'mocked func 4: %s, id: %s'</span> % (rs7, id(rs7)))</span><br><span class="line">    print(<span class="string">'mocked func 5: %s, id: %s'</span> % (rs8, id(rs8)))</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mocked func 4: my simple mock, id: 1571113957680</span><br><span class="line">mocked func 5: my simple mock, id: 1571113957680</span><br></pre></td></tr></table></figure>
</li>
<li><p>陷阱</p>
<ul>
<li>在mock函数、静态函数、单例类函数时，由于全局只有一个实例，会导致一旦mock之后，代码中所有调用该函数的值都变成mock后的值</li>
</ul>
</li>
</ul>
<ul>
<li><p>解决方案：使用patch</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> unittest.mock <span class="keyword">import</span> Mock, patch</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SingletonClass</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(cls, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> hasattr(cls, <span class="string">'_instance'</span>):</span><br><span class="line">            origin = super(SingletonClass, cls)</span><br><span class="line">            cls._instance = origin.__new__(cls, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> cls._instance</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">singleton_func</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'singleton func: %s'</span> % data</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    singleton_cls = SingletonClass()</span><br><span class="line"></span><br><span class="line">    print(<span class="string">'===============CONTEXT============'</span>)</span><br><span class="line">    print(singleton_cls.singleton_func(<span class="string">'no patch'</span>))</span><br><span class="line">    <span class="keyword">with</span> patch(<span class="string">'__main__.SingletonClass.singleton_func'</span>) <span class="keyword">as</span> patched_func:</span><br><span class="line">        patched_func.return_value = <span class="string">'patched'</span></span><br><span class="line">        print(singleton_cls.singleton_func(<span class="string">'no patch'</span>))</span><br><span class="line">    print(singleton_cls.singleton_func(<span class="string">'no patch'</span>))</span><br><span class="line"></span><br><span class="line">    print(<span class="string">'===============START&amp;STOP============'</span>)</span><br><span class="line">    p = patch(<span class="string">'__main__.SingletonClass.singleton_func'</span>, return_value=<span class="string">'patched'</span>)</span><br><span class="line">    p.start()</span><br><span class="line">    print(singleton_cls.singleton_func(<span class="string">'no patch'</span>))</span><br><span class="line">    p.stop()</span><br><span class="line">    print(singleton_cls.singleton_func(<span class="string">'no patch'</span>))</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">===============CONTEXT============</span><br><span class="line">singleton func: no patch</span><br><span class="line">patched</span><br><span class="line">singleton func: no patch</span><br><span class="line">===============START&amp;STOP============</span><br><span class="line">patched</span><br><span class="line">singleton func: no patch</span><br></pre></td></tr></table></figure>
</li>
<li><p>可以看到，不论使用哪种方法，之前被patch掉的函数还会恢复到正常的值</p>
</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>Mock本质上是monkey patch</li>
<li>全局唯一的对象，被mock后会影响到全局调用</li>
<li>使用patch 可以避免全局调用，可以使用上下文或者 start&amp;stop</li>
</ul>

  </div>
</article>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/gabithume">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#现象"><span class="toc-number">1.</span> <span class="toc-text">现象</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#普通函数和静态函数"><span class="toc-number">1.0.1.</span> <span class="toc-text">普通函数和静态函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#单例模式下的函数"><span class="toc-number">1.0.2.</span> <span class="toc-text">单例模式下的函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#普通类的函数"><span class="toc-number">1.0.3.</span> <span class="toc-text">普通类的函数</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#原理"><span class="toc-number">2.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">3.</span> <span class="toc-text">总结</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://cnds.github.io/2019/03/01/Python Mock的细节/"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://cnds.github.io/2019/03/01/Python Mock的细节/&text=Python Mock 的细节"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://cnds.github.io/2019/03/01/Python Mock的细节/&title=Python Mock 的细节"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://cnds.github.io/2019/03/01/Python Mock的细节/&is_video=false&description=Python Mock 的细节"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Python Mock 的细节&body=Check out this article: http://cnds.github.io/2019/03/01/Python Mock的细节/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://cnds.github.io/2019/03/01/Python Mock的细节/&title=Python Mock 的细节"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://cnds.github.io/2019/03/01/Python Mock的细节/&title=Python Mock 的细节"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://cnds.github.io/2019/03/01/Python Mock的细节/&title=Python Mock 的细节"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://cnds.github.io/2019/03/01/Python Mock的细节/&title=Python Mock 的细节"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://cnds.github.io/2019/03/01/Python Mock的细节/&name=Python Mock 的细节&description="><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick='$("#toc-footer").toggle();return false;'><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick='$("#share-footer").toggle();return false;'><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick='$("#nav-footer").toggle();return false;'><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2020 Ding Song
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="http://github.com/gabithume">Projects</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" href="/lib/meslo-LG/styles.css">
<link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">


<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-86660611-1', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Disqus Comments -->


